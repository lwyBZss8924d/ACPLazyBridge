# Implementation Plan: Normalize JSONL fixtures to ACP v1 protocolVersion

```yaml
worktree: /Users/arthur/dev-space/acplb-worktrees/037-normalize-jsonl-protocol-v1
feature_branch: chore/037-normalize-jsonl-protocol-v1
created: 2025-09-21T19:30:00Z
last_updated: 2025-09-21T20:50:06Z
status: in_progress
input: Feature specification from `/specs/037-normalize-jsonl-protocol-v1/spec.md`
issue_uri: https://github.com/lwyBZss8924d/ACPLazyBridge/issues/14
spec_uri: specs/037-normalize-jsonl-protocol-v1/spec.md
plan_uri: specs/037-normalize-jsonl-protocol-v1/plan.md
tasks_uri: specs/037-normalize-jsonl-protocol-v1/tasks.md
evidence_uris: _artifacts/037-normalize-jsonl-protocol-v1/
specs:
    constitution: 1.0.1
    type: plan
    feature_number: 037
```

## Execution Flow (/plan command scope)

```text
1. Load feature spec from specs/037-normalize-jsonl-protocol-v1/spec.md
   → Requirements clear: normalize protocolVersion to integer
2. Fill Technical Context
   → Project Type: single (Rust workspace)
   → Tool: sed/jq for JSON manipulation
3. Evaluate Constitution Check
   → Simplicity: Single focused task, minimal changes
   → Test-First: Fixing test fixtures to align with spec
   → Integration-First: Ensuring fixtures work with upstream crate
4. Execute Phase 0 → research.md
   → ACP specification already researched
5. Execute Phase 1 → No contracts needed (fixing existing fixtures)
6. Re-evaluate Constitution Check
   → All principles satisfied
7. Plan Phase 2 → Task generation approach ready
8. STOP - Ready for /tasks command
```

## Summary

Normalize all JSONL test fixtures in dev-docs/review/_artifacts/tests/ to use integer protocolVersion 1, aligning with ACP v1 specification and enabling compatibility with the upstream agent-client-protocol crate.

## Technical Context

**Language/Version**: Bash/Shell scripting, JSON manipulation
**Primary Dependencies**: jq (JSON processor), sed (stream editor)
**Storage**: N/A
**Testing**: cargo run -p codex-cli-acp (playback testing)
**Target Platform**: Development/CI environments
**Project Type**: single - Simple maintenance task
**Performance Goals**: N/A
**Constraints**: Preserve all other JSON structure
**Scale/Scope**: ~20 JSONL files, 1 shell script

## Constitution Check

_GATE: Must pass before Phase 0 research. Re-check after Phase 1 design._

**Simplicity**:

- Projects: 1 (single focused task)
- Using framework directly? Yes (native tools)
- Single data model? Yes (JSONL format)
- Avoiding patterns? Yes (simple find/replace)

**Architecture**:

- EVERY feature as library? N/A (maintenance task)
- Libraries listed: N/A
- CLI per library: N/A
- Library docs: N/A

**Testing (NON-NEGOTIABLE)**:

- RED-GREEN-Refactor cycle enforced? N/A (fixing test fixtures)
- Git commits show tests before implementation? Test fixtures ARE the tests
- Order: Fixing test infrastructure
- Real dependencies used? Yes (actual JSONL files)
- Integration tests for: Will validate with playback
- FORBIDDEN: N/A

**Observability**:

- Structured logging included? Yes (capture sed/jq output)
- Frontend logs → backend? N/A
- Error context sufficient? Yes

**Versioning**:

- Version number assigned? N/A (fixture update)
- BUILD increments on every change? N/A
- Breaking changes handled? No breaking changes

## Project Structure

### Documentation (this feature)

```tree
specs/037-normalize-jsonl-protocol-v1/
├── spec.md              # Requirements (complete)
├── plan.md              # This file
├── tasks.md             # To be generated by /tasks
└── research.md          # Protocol research (optional)
```

### Source Code (repository root)

```tree
dev-docs/review/_artifacts/tests/
├── *.jsonl              # Test fixtures to update
└── test_streaming.sh    # Script to update

_artifacts/037-normalize-jsonl-protocol-v1/
├── tests/               # Playback test results
├── logs/                # Update logs
└── reports/             # Validation reports
```

**Structure Decision**: Single maintenance task, no new code structure needed

## Phase 0: Outline & Research

1. **Research completed**:
   - ACP JSON Schema defines protocolVersion as integer (uint16)
   - Current fixtures use string "2024-11-05" or "1"
   - 2 fixtures already correct (acp_v1_alignment.jsonl, vec_string_command.jsonl)

2. **Findings**:
   - Decision: Use integer 1 for all fixtures
   - Rationale: ACP v1 specification requirement
   - Alternatives considered: None (specification mandates integer)

**Output**: Research incorporated into spec.md

## Phase 1: Design & Contracts

_Prerequisites: Research complete_

This is a maintenance task with no new contracts or data models needed.

1. **Approach**:
   - Use jq to parse and update JSON
   - Preserve all other fields exactly
   - Validate JSON structure after updates

2. **Validation**:
   - All files must remain valid JSON
   - Playback tests must pass
   - No other fields should be modified

**Output**: No new artifacts needed

## Phase 2: Task Planning Approach

**Task Generation Strategy**:

- Batch update tasks for efficiency
- Group by protocolVersion value type
- Validate after each batch
- Test playback after all updates

**Ordering Strategy**:

1. Create evidence directory
2. Backup existing fixtures
3. Fix "2024-11-05" strings (11 files)
4. Fix "1" string (1 file)
5. Fix test_streaming.sh script
6. Validate JSON structure
7. Run playback tests
8. Generate report

**Estimated Output**: 8-10 numbered tasks in tasks.md

## Pre-PR Validation

_Quality gates before submitting pull request_

**SDD Document Validation**:

- [x] Run `scripts/sdd/validate-sdd-docs.sh`
- [x] No [NEEDS CLARIFICATION] markers
- [x] No placeholder values

**Code Quality Gates**:

- [ ] JSON validation passes (`jq . < file.jsonl`)
- [ ] Playback tests pass (`cargo run -p codex-cli-acp`)
- [ ] No regression in existing tests

## Phase 3+: Future Implementation

**Phase 3**: Task execution (/tasks command creates tasks.md)
**Phase 4**: Implementation (execute tasks.md)
**Phase 5**: Validation (run playback tests)
**Phase 6**: Pre-PR validation

## Complexity Tracking

_No violations - this is a simple, focused maintenance task_

## Progress Tracking

_This checklist is updated during execution flow_

**Phase Status**:

- [x] Phase 0: Research complete
- [x] Phase 1: Design complete
- [x] Phase 2: Task planning complete
- [ ] Phase 3: Tasks generated
- [ ] Phase 4: Implementation complete
- [ ] Phase 5: Validation passed

**Gate Status**:

- [x] Initial Constitution Check: PASS
- [x] Post-Design Constitution Check: PASS
- [x] All NEEDS CLARIFICATION resolved
- [x] Complexity deviations documented (none)

## IMPORTANT TECHNICAL STANDARDS

- [ACP](https://github.com/zed-industries/agent-client-protocol) - "ACPLazyBridge" follow `ACP` Protocol
- [ACP JSON Schema](https://github.com/zed-industries/agent-client-protocol/blob/main/schema/schema.json) - "ACPLazyBridge" follow `ACP` JSON Schema
- **ACP Repository local path**: (~/dev-space/agent-client-protocol)

---

⚠️ _Based on SDD CONSTITUTION: `.specify/memory/constitution.md`_
⚠️ _Follow the SDD workflow implementation: `.specify/memory/lifecycle.md`_
⚠️ _Follow the SDD rules: `sdd-rules/rules/README.md`_
